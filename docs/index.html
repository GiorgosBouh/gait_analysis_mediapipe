<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BioGait 3D - Sagittal/Side View Optimized</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0f172a; --panel: #1e293b; --text: #f8fafc;
      --accent: #38bdf8; --success: #10b981; --danger: #ef4444; --warn: #f59e0b;
      --border: #334155;
    }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
    
    /* Layout */
    .app-container { display: grid; grid-template-columns: 350px 1fr; grid-template-rows: 60px 1fr; height: 100%; }
    
    .header { grid-column: 1 / -1; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
    .header h1 { font-size: 1.1rem; font-weight: 800; color: var(--accent); margin: 0; display:flex; align-items:center; gap:10px; text-transform: uppercase; letter-spacing: 1px; }
    .status-badge { background: #334155; color: #fff; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; }

    .sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; z-index: 5; }
    
    .main-view { position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); overflow: hidden; }
    
    /* PIP Video Top Right */
    .video-pip {
      position: absolute; top: 20px; right: 20px; width: 320px; aspect-ratio: 16/9;
      background: #000; border: 1px solid #475569; border-radius: 8px; overflow: hidden;
      z-index: 10; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .video-pip video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

    /* Controls */
    .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 8px; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--accent); color: #0f172a; }
    .btn-primary:hover:not(:disabled) { background: #0ea5e9; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-secondary { background: #475569; color: #fff; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }

    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 0.75rem; margin-bottom: 4px; color: #cbd5e1; }
    .input-group input, .input-group select { width: 100%; padding: 8px; background: #0f172a; border: 1px solid var(--border); color: white; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }

    /* Calibration Progress */
    #calibProgress { width: 100%; height: 6px; background: #334155; border-radius: 3px; margin-top: 5px; overflow: hidden; display: none; }
    #calibBar { width: 0%; height: 100%; background: var(--success); transition: width 0.1s linear; }

    /* Report Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .modal-content {
      background: var(--panel); width: 95%; max-width: 1000px; max-height: 95vh;
      border: 1px solid var(--border); border-radius: 12px; padding: 24px;
      overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
    }
    .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
    .report-table th, .report-table td { border: 1px solid var(--border); padding: 8px; text-align: center; }
    .report-table th { background: #334155; color: #fff; text-transform: uppercase; font-size: 0.75rem; }
    .report-table tr:nth-child(even) { background: #1e293b; }
    .report-header { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; justify-content:space-between; }

    /* Instructions Box */
    .instruction-box { background: rgba(51, 65, 85, 0.5); border-left: 3px solid var(--accent); padding: 10px; font-size: 0.75rem; color: #cbd5e1; line-height: 1.4; margin-bottom: 15px; }

    /* Loading Screen */
    #loadingScreen {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm"
      }
    }
  </script>
</head>
<body>

  <div id="loadingScreen">
    <div class="spinner"></div>
    <h2 style="margin-top:20px; font-size:1rem; letter-spacing:1px;">INITIALIZING BIOGAIT 3D...</h2>
  </div>

  <div class="app-container">
    <header class="header">
      <h1>BioGait 3D <span style="font-size:0.7em; color:#64748b; margin-left:5px;">Side-View Edition</span></h1>
      <div id="statusBadge" class="status-badge">SYSTEM LOADING</div>
    </header>

    <aside class="sidebar">
      <div>
        <div class="section-title">1. Camera Setup</div>
        <div class="instruction-box">
          <strong>Camera Position (Side View):</strong><br>
          Place camera perpendicular to walking path (90Â°).<br>
          Ensure subject fits head-to-toe.<br>
          Subject should walk Left-to-Right or Right-to-Left.
        </div>
        <button id="btnCamera" class="btn btn-primary" disabled>Open Camera</button>
        <div class="input-group">
          <label>Subject Height (m)</label>
          <input type="number" id="inputHeight" value="1.75" step="0.01">
        </div>
      </div>

      <div>
        <div class="section-title">2. Calibration</div>
        <p style="font-size:0.7rem; color:#94a3b8; margin-bottom:8px;">Stand centered in view (T-Pose) for 3s.</p>
        <button id="btnCalibrate" class="btn btn-success" disabled>Calibrate (3s)</button>
        <div id="calibProgress"><div id="calibBar"></div></div>
        <div class="input-group" style="margin-top:8px;">
          <input type="text" id="lblScale" value="Not Calibrated" disabled style="text-align:center;">
        </div>
      </div>

      <div>
        <div class="section-title">3. Acquisition</div>
        <button id="btnRecord" class="btn btn-danger" disabled>Start Walking</button>
        <button id="btnStop" class="btn btn-secondary" disabled>Stop & Analyze</button>
        <button id="btnReset" class="btn btn-secondary" disabled>Reset Data</button>
      </div>
    </aside>

    <main class="main-view" id="canvasContainer"></main>

    <div class="video-pip">
      <video id="videoElement" autoplay playsinline muted></video>
      <div style="position:absolute; top:5px; left:5px; font-size:0.7rem; background:rgba(0,0,0,0.5); padding:2px 5px; color:#fff;">LIVE FEED</div>
    </div>
  </div>

  <div class="modal-overlay" id="reportModal">
    <div class="modal-content">
      <div class="report-header">
        <div>Gait Analysis Results <span style="font-size:0.8rem; font-weight:normal; color:#fff;">(Side View Detected)</span></div>
        <button onclick="document.getElementById('reportModal').style.display='none'" style="background:none; border:none; color:#fff; cursor:pointer; font-size:1.5rem;">&times;</button>
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div>
          <h3 style="color:#fff; font-size:0.9rem; border-bottom:1px solid #334155; padding-bottom:5px;">Spatio-Temporal</h3>
          <table class="report-table">
            <tr><td>Avg Speed</td><td id="repSpeed" class="val">-</td></tr>
            <tr><td>Cadence</td><td id="repCadence" class="val">-</td></tr>
            <tr><td>Stride Length</td><td id="repStride" class="val">-</td></tr>
            <tr><td>Step Length</td><td id="repStep" class="val">-</td></tr>
          </table>
        </div>
        <div>
          <h3 style="color:#fff; font-size:0.9rem; border-bottom:1px solid #334155; padding-bottom:5px;">Cycle Info</h3>
          <table class="report-table">
            <tr><td>Total Steps Detected</td><td id="repStepsCount" class="val">-</td></tr>
            <tr><td>Recording Duration</td><td id="repDuration" class="val">-</td></tr>
            <tr><td>Analysis View</td><td id="repView" class="val" style="color:#f59e0b;">-</td></tr>
          </table>
        </div>
      </div>

      <h3 style="color:#fff; font-size:0.9rem; margin-top:20px; border-bottom:1px solid #334155; padding-bottom:5px;">Sagittal Plane Kinematics (Avg Degrees)</h3>
      <table class="report-table">
        <thead>
          <tr>
            <th>Joint</th>
            <th>Initial Contact (IC)</th>
            <th>Mid-Stance (MSt)</th>
            <th>Push-Off (PO)</th>
            <th>Swing Peak (Sw)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td><strong>Right Hip</strong> (Flex/Ext)</td><td id="rh_ic">-</td><td id="rh_mst">-</td><td id="rh_po">-</td><td id="rh_sw">-</td></tr>
          <tr><td><strong>Left Hip</strong> (Flex/Ext)</td><td id="lh_ic">-</td><td id="lh_mst">-</td><td id="lh_po">-</td><td id="lh_sw">-</td></tr>
          <tr><td><strong>Right Knee</strong> (Flexion)</td><td id="rk_ic">-</td><td id="rk_mst">-</td><td id="rk_po">-</td><td id="rk_sw">-</td></tr>
          <tr><td><strong>Left Knee</strong> (Flexion)</td><td id="lk_ic">-</td><td id="lk_mst">-</td><td id="lk_po">-</td><td id="lk_sw">-</td></tr>
          <tr><td><strong>Right Ankle</strong> (Dorsi/Plant)</td><td id="ra_ic">-</td><td id="ra_mst">-</td><td id="ra_po">-</td><td id="ra_sw">-</td></tr>
          <tr><td><strong>Left Ankle</strong> (Dorsi/Plant)</td><td id="la_ic">-</td><td id="la_mst">-</td><td id="la_po">-</td><td id="la_sw">-</td></tr>
        </tbody>
      </table>
      
      <div style="margin-top:20px; text-align:right;">
        <button class="btn btn-primary" style="width:auto; display:inline-block;" onclick="downloadCSV()">Download Full CSV</button>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { PoseLandmarker, FilesetResolver } from '@mediapipe/tasks-vision';

    const MODEL_PATH = "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task";
    
    // State
    const state = {
      calibrated: false,
      recording: false,
      scale: 1.0, 
      frames: [],
      calibrationBuffer: []
    };

    // UI Refs
    const els = {
      loading: document.getElementById('loadingScreen'),
      status: document.getElementById('statusBadge'),
      vid: document.getElementById('videoElement'),
      btnCam: document.getElementById('btnCamera'),
      btnCal: document.getElementById('btnCalibrate'),
      btnRec: document.getElementById('btnRecord'),
      btnStop: document.getElementById('btnStop'),
      btnReset: document.getElementById('btnReset'),
      lblScale: document.getElementById('lblScale'),
      calBar: document.getElementById('calibBar'),
      calProg: document.getElementById('calibProgress'),
      modal: document.getElementById('reportModal')
    };

    // 3D Refs
    let scene, camera, renderer, controls, poseLandmarker;
    const joints = [], bones = [];
    const POSE_CONNECTIONS = PoseLandmarker.POSE_CONNECTIONS;

    // --- INIT ---
    async function init() {
      initThreeJS();
      try {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/wasm");
        poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
          baseOptions: { modelAssetPath: MODEL_PATH, delegate: "GPU" },
          runningMode: "VIDEO",
          numPoses: 1
        });
        els.loading.style.display = 'none';
        els.status.innerText = "READY"; els.status.style.background = "#10b981";
        els.btnCam.disabled = false;
      } catch (e) { alert("AI Load Error: " + e.message); }
    }

    function initThreeJS() {
      const cont = document.getElementById('canvasContainer');
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(50, cont.clientWidth/cont.clientHeight, 0.1, 100);
      camera.position.set(0, 1.2, 3.5);
      
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(cont.clientWidth, cont.clientHeight);
      cont.appendChild(renderer.domElement);
      
      controls = new OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 0.9, 0);
      controls.enableDamping = true;

      scene.add(new THREE.GridHelper(6, 12, 0x334155, 0x000000));
      const light = new THREE.DirectionalLight(0xffffff, 1.5);
      light.position.set(2, 5, 5);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));

      // Skeleton
      const jGeo = new THREE.SphereGeometry(0.04);
      const jMat = new THREE.MeshStandardMaterial({color:0xffffff});
      for(let i=0; i<33; i++){
        const m = new THREE.Mesh(jGeo, jMat.clone());
        m.visible=false; scene.add(m); joints.push(m);
      }
      const bGeo = new THREE.CylinderGeometry(0.015,0.015,1);
      const bMat = new THREE.MeshStandardMaterial({color:0x94a3b8});
      POSE_CONNECTIONS.forEach(c => {
        const m = new THREE.Mesh(bGeo, bMat.clone());
        m.visible=false; scene.add(m); bones.push({mesh:m, s:c.start, e:c.end});
      });

      const animate = () => { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); };
      animate();
    }

    // --- APP LOGIC ---
    els.btnCam.addEventListener('click', async () => {
      try {
        const s = await navigator.mediaDevices.getUserMedia({video:{width:1280, height:720}});
        els.vid.srcObject = s;
        els.vid.onloadeddata = () => {
          els.btnCam.disabled = true; els.btnCal.disabled = false;
          els.status.innerText = "PREVIEW"; els.status.style.background="#0ea5e9";
          predictLoop();
        }
      } catch(e){ alert("Camera denied"); }
    });

    els.btnCal.addEventListener('click', () => {
      state.calibrationBuffer = [];
      els.calProg.style.display = 'block';
      els.calBar.style.width = '0%';
      els.btnCal.disabled = true;
      els.status.innerText = "CALIBRATING..."; els.status.style.background="#f59e0b";
      
      let p = 0;
      const t = setInterval(() => {
        p += 5; els.calBar.style.width = p+"%";
        if(p>=100){ clearInterval(t); finishCalibration(); }
      }, 150);
      state.calibrating = true;
    });

    function finishCalibration() {
      state.calibrating = false;
      els.calProg.style.display = 'none';
      if(state.calibrationBuffer.length < 10) {
        alert("Calibration failed. Stand clearly visible.");
        els.btnCal.disabled = false;
        return;
      }
      // Height = Nose Y to Mid-Ankle Y
      const vals = state.calibrationBuffer.sort((a,b)=>a-b);
      const med = vals[Math.floor(vals.length/2)];
      const realH = parseFloat(document.getElementById('inputHeight').value);
      state.scale = realH / med;
      els.lblScale.value = `Scale: ${state.scale.toFixed(3)}`;
      els.btnCal.disabled = true; els.btnRec.disabled = false;
      els.status.innerText = "CALIBRATED"; els.status.style.background="#10b981";
    }

    els.btnRec.addEventListener('click', () => {
      state.frames = [];
      state.recording = true;
      els.btnRec.disabled = true; els.btnStop.disabled = false; els.btnReset.disabled = true;
      els.status.innerText = "RECORDING"; els.status.style.background="#ef4444";
    });

    els.btnStop.addEventListener('click', () => {
      state.recording = false;
      els.btnStop.disabled = true; els.btnReset.disabled = false;
      els.status.innerText = "ANALYZING..."; els.status.style.background="#8b5cf6";
      analyzeSideView();
    });

    els.btnReset.addEventListener('click', () => {
      state.frames = [];
      els.btnRec.disabled = false; els.btnReset.disabled = true;
      els.modal.style.display = 'none';
      els.status.innerText = "READY"; els.status.style.background="#10b981";
    });

    let lastT = -1;
    function predictLoop() {
      if(els.vid.currentTime !== lastT){
        lastT = els.vid.currentTime;
        const res = poseLandmarker.detectForVideo(els.vid, performance.now());
        if(res.worldLandmarks.length){
          const lm = res.worldLandmarks[0];
          drawSkeleton(lm);
          if(state.calibrating) {
            const h = Math.abs(lm[0].y - (lm[27].y+lm[28].y)/2);
            state.calibrationBuffer.push(h);
          }
          if(state.recording) {
            // Compute angles
            const rK = angle(lm[24],lm[26],lm[28]);
            const lK = angle(lm[23],lm[25],lm[27]);
            const rH = angle(lm[12],lm[24],lm[26]);
            const lH = angle(lm[11],lm[23],lm[25]);
            const rA = angle(lm[26],lm[28],lm[32]);
            const lA = angle(lm[25],lm[27],lm[31]);
            state.frames.push({
              t: els.vid.currentTime,
              lm: JSON.parse(JSON.stringify(lm)),
              ang: {rK,lK,rH,lH,rA,lA}
            });
          }
        }
      }
      requestAnimationFrame(predictLoop);
    }

    function drawSkeleton(lm) {
      const s = state.calibrated ? state.scale : 1.0;
      for(let i=0; i<33; i++){
        joints[i].position.set(lm[i].x*s, -lm[i].y*s+(state.calibrated?1:0), -lm[i].z*s);
        joints[i].visible = true;
        joints[i].material.color.setHex((i>10 && i%2!==0) ? 0x0ea5e9 : (i>10?0xef4444:0xffffff));
      }
      bones.forEach(b => {
        const p1 = joints[b.s].position, p2 = joints[b.e].position;
        b.mesh.position.copy(p1).add(p2).multiplyScalar(0.5);
        b.mesh.lookAt(p2); b.mesh.rotateX(Math.PI/2);
        b.mesh.scale.set(1, p1.distanceTo(p2), 1);
        b.mesh.visible = true;
      });
    }

    function angle(a,b,c) {
      const v1={x:a.x-b.x,y:a.y-b.y,z:a.z-b.z}, v2={x:c.x-b.x,y:c.y-b.y,z:c.z-b.z};
      const dot = v1.x*v2.x+v1.y*v2.y+v1.z*v2.z;
      const mag = Math.sqrt(v1.x**2+v1.y**2+v1.z**2) * Math.sqrt(v2.x**2+v2.y**2+v2.z**2);
      return 180 - (Math.acos(dot/mag)*180/Math.PI);
    }

    // --- ANALYSIS FOR SIDE VIEW (X-AXIS) ---
    function analyzeSideView() {
      const fr = state.frames;
      if(fr.length < 30) { alert("Too short"); return; }
      
      const s = state.scale;
      
      // Detect dominant axis (Left-Right motion = X axis variation)
      const xVals = fr.map(f => f.lm[27].x); // L Ankle X
      const zVals = fr.map(f => f.lm[27].z); // L Ankle Z
      const rangeX = Math.max(...xVals) - Math.min(...xVals);
      const rangeZ = Math.max(...zVals) - Math.min(...zVals);
      
      const isSideView = rangeX > rangeZ; 
      document.getElementById('repView').innerText = isSideView ? "Sagittal (Side)" : "Frontal (Unsupported)";

      // Step Detection via Ankle Separation (Distance between ankles along movement axis)
      // When |Lx - Rx| is max -> Stride Extension (Heel Strike)
      let steps = 0;
      let lastDist = 0;
      let peaks = [];

      for(let i=1; i<fr.length-1; i++) {
        // Distance between ankles on X axis (Side view)
        const dPrev = Math.abs(fr[i-1].lm[27].x - fr[i-1].lm[28].x);
        const dCurr = Math.abs(fr[i].lm[27].x - fr[i].lm[28].x);
        const dNext = Math.abs(fr[i+1].lm[27].x - fr[i+1].lm[28].x);
        
        if (dCurr > dPrev && dCurr > dNext && dCurr > 0.15) { // Peak separation > 15cm threshold (approx)
           peaks.push(i);
           steps++;
        }
      }

      // Calculations
      const duration = fr[fr.length-1].t - fr[0].t;
      const cadence = (steps / (duration/60)); 
      
      // Avg Stride Length (Max separation * scale)
      const dists = peaks.map(i => Math.abs(fr[i].lm[27].x - fr[i].lm[28].x) * s);
      const avgStride = dists.length ? (dists.reduce((a,b)=>a+b)/dists.length * 2) : 0; // *2 roughly for stride vs step extent, heuristic
      const stepLen = avgStride / 2;
      
      // Speed = Stride * Cadence is safer for MP World Coordinates than trying to integrate velocity
      // Formula: Speed (m/min) = Cadence * StrideLen -> /60 for m/s
      // Actually: Speed = (StepLen * Steps) / Time
      const avgSpeed = (steps * stepLen) / duration;

      // Fill Basic Report
      document.getElementById('repSpeed').innerText = avgSpeed.toFixed(2) + " m/s";
      document.getElementById('repCadence').innerText = cadence.toFixed(0) + " spm";
      document.getElementById('repStride').innerText = avgStride.toFixed(2) + " m";
      document.getElementById('repStep').innerText = stepLen.toFixed(2) + " m";
      document.getElementById('repStepsCount').innerText = steps;
      document.getElementById('repDuration').innerText = duration.toFixed(1) + " s";

      // --- KINEMATICS AVERAGING ---
      // We need to find indices for IC, Mid, PO. 
      // Simplified: Peak Separation = IC. Minimum Separation = Mid-Swing/Mid-Stance crossover.
      
      // Collect values at peaks (IC)
      let ic_idxs = peaks;
      
      // Collect values between peaks (Mid Stance approx)
      let mst_idxs = [];
      for(let j=0; j<peaks.length-1; j++) {
         mst_idxs.push(Math.floor((peaks[j] + peaks[j+1])/2));
      }
      
      function getAvg(indices, key) {
        if(!indices.length) return "-";
        let sum = 0;
        indices.forEach(idx => sum += fr[idx].ang[key]);
        return (sum/indices.length).toFixed(1);
      }

      // Right Leg Data
      document.getElementById('rh_ic').innerText = getAvg(ic_idxs, 'rH');
      document.getElementById('rk_ic').innerText = getAvg(ic_idxs, 'rK');
      document.getElementById('ra_ic').innerText = getAvg(ic_idxs, 'rA');
      
      document.getElementById('rh_mst').innerText = getAvg(mst_idxs, 'rH');
      document.getElementById('rk_mst').innerText = getAvg(mst_idxs, 'rK');
      document.getElementById('ra_mst').innerText = getAvg(mst_idxs, 'rA');

      // Left Leg Data (Note: When R is IC, L is likely Push Off or Mid Stance depending on phase)
      // For simplicity in this demo, we just average the frames where legs are max extended.
      document.getElementById('lh_ic').innerText = getAvg(ic_idxs, 'lH');
      document.getElementById('lk_ic').innerText = getAvg(ic_idxs, 'lK');
      document.getElementById('la_ic').innerText = getAvg(ic_idxs, 'lA');

      els.modal.style.display = 'flex';
    }

    // Export
    window.downloadCSV = function() {
      if(!state.frames.length) return;
      let c = "Time,StepLenEst,RHip,LHip,RKnee,LKnee,RAnk,LAnk,RX,RY,RZ,LX,LY,LZ\n";
      const s = state.scale;
      state.frames.forEach(f => {
        const step = Math.abs(f.lm[27].x - f.lm[28].x) * s;
        c += `${f.t.toFixed(3)},${step.toFixed(3)},` + 
             `${f.ang.rH.toFixed(1)},${f.ang.lH.toFixed(1)},` + 
             `${f.ang.rK.toFixed(1)},${f.ang.lK.toFixed(1)},` +
             `${f.ang.rA.toFixed(1)},${f.ang.lA.toFixed(1)},` + 
             `${(f.lm[28].x*s).toFixed(3)},${(-f.lm[28].y*s).toFixed(3)},${(-f.lm[28].z*s).toFixed(3)},` +
             `${(f.lm[27].x*s).toFixed(3)},${(-f.lm[27].y*s).toFixed(3)},${(-f.lm[27].z*s).toFixed(3)}\n`;
      });
      const b = new Blob([c], {type:'text/csv'});
      const u = URL.createObjectURL(b);
      const a = document.createElement('a'); a.href=u; a.download=`biogait_side_${Date.now()}.csv`; a.click();
    }

    init();
  </script>
</body>
</html>