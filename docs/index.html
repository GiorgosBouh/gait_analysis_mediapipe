<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BioGait 3D Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0b1120; --panel: #1e293b; --text: #f8fafc;
      --accent: #38bdf8; --success: #10b981; --danger: #ef4444; --warn: #f59e0b;
    }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; }
    
    /* Layout */
    .app-container { display: grid; grid-template-columns: 300px 1fr; grid-template-rows: 60px 1fr; height: 100vh; }
    
    .header { grid-column: 1 / -1; background: var(--panel); border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
    .header h1 { font-size: 1.2rem; font-weight: 800; color: var(--accent); margin: 0; display:flex; align-items:center; gap:10px; }
    .status-badge { background: var(--warn); color: #000; padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; }

    .sidebar { background: var(--panel); border-right: 1px solid #334155; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; z-index: 2; }
    
    .main-view { position: relative; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); overflow: hidden; }
    
    /* Video Pip */
    .video-pip {
      position: absolute; bottom: 20px; left: 20px; width: 200px; aspect-ratio: 16/9;
      background: #000; border: 1px solid #475569; border-radius: 8px; overflow: hidden;
      z-index: 10; transition: all 0.3s; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
    }
    .video-pip video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

    /* Controls */
    .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 10px; font-weight: 700; border-bottom: 1px solid #334155; padding-bottom: 5px; }
    .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-bottom: 8px; font-size: 0.9rem; }
    .btn-primary { background: var(--accent); color: #0f172a; }
    .btn-primary:hover:not(:disabled) { background: #0ea5e9; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #cbd5e1; }
    .input-group input { width: 100%; padding: 8px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 4px; font-family: 'JetBrains Mono', monospace; }

    /* Overlay Metrics */
    .metrics-panel {
      position: absolute; top: 20px; right: 20px; width: 220px;
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px);
      padding: 15px; border-radius: 8px; border: 1px solid #334155;
      font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
      pointer-events: none; user-select: none;
    }
    .metric-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .val { color: var(--accent); font-weight: bold; }

    /* Loading / Error Screen */
    #loadingScreen {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; text-align: center;
    }
    .spinner { width: 50px; height: 50px; border: 4px solid var(--panel); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #debugLog {
      margin-top: 20px; width: 100%; max-width: 600px; height: 200px;
      background: #000; border: 1px solid #334155; color: #22c55e;
      font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
      padding: 10px; overflow-y: auto; text-align: left;
    }
    .log-err { color: #ef4444; }
    .log-warn { color: #f59e0b; }

  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm"
      }
    }
  </script>
</head>
<body>

  <div id="loadingScreen">
    <div class="spinner" id="spinner"></div>
    <h2 id="loadingText">Initializing Scientific Engine...</h2>
    <p style="color: #64748b; font-size: 0.9rem;">Downloading 3D components & AI Models (~10MB)</p>
    <div id="debugLog"></div>
    <button id="btnRetry" class="btn btn-primary" style="width: 200px; display: none; margin-top: 20px;" onclick="window.location.reload()">RETRY RELOAD</button>
  </div>

  <div class="app-container">
    <header class="header">
      <h1>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
        BioGait 3D <span style="font-size:0.8rem; opacity:0.6; margin-left:10px;">v2.1</span>
      </h1>
      <div id="systemStatus" class="status-badge">STANDBY</div>
    </header>

    <aside class="sidebar">
      <div>
        <div class="section-title">1. Camera & Setup</div>
        <button id="btnCamera" class="btn btn-primary" disabled>Open Camera</button>
        <div class="input-group">
          <label>Subject Height (m)</label>
          <input type="number" id="inputHeight" value="1.75" step="0.01">
        </div>
      </div>

      <div>
        <div class="section-title">2. Calibration</div>
        <p style="font-size:0.75rem; color:#64748b;">Subject must stand in T-Pose or Neutral pose fully visible.</p>
        <button id="btnCalibrate" class="btn btn-success" disabled>Calibrate Scale</button>
        <div class="input-group" style="margin-top:10px;">
          <label>Scale Factor (Meters/Unit)</label>
          <input type="text" id="lblScale" value="Uncalibrated" disabled style="color: var(--accent);">
        </div>
      </div>

      <div>
        <div class="section-title">3. Capture</div>
        <button id="btnRecord" class="btn btn-danger" disabled>Start Recording</button>
        <button id="btnStop" class="btn" style="background:#334155; color:white;" disabled>Stop</button>
      </div>

      <div style="margin-top:auto;">
        <button id="btnExport" class="btn btn-primary" disabled>Export CSV Data</button>
      </div>
    </aside>

    <main class="main-view" id="canvasContainer">
      <div class="metrics-panel" id="metricsOverlay" style="display:none;">
        <div class="metric-row" style="border-bottom:1px solid #334155; padding-bottom:5px; margin-bottom:10px; color:#fff;">LIVE METRICS</div>
        <div class="metric-row"><span>Gait Phase:</span> <span class="val" id="valPhase">-</span></div>
        <div class="metric-row"><span>Right Knee:</span> <span class="val" id="valRKnee">0째</span></div>
        <div class="metric-row"><span>Left Knee:</span> <span class="val" id="valLKnee">0째</span></div>
        <div class="metric-row"><span>Step Len:</span> <span class="val" id="valStep">-</span></div>
      </div>
    </main>

    <div class="video-pip">
      <video id="videoElement" autoplay playsinline muted></video>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { PoseLandmarker, FilesetResolver } from '@mediapipe/tasks-vision';

    // --- LOGGER ---
    const debugLog = document.getElementById('debugLog');
    function log(msg, type = 'info') {
      const line = document.createElement('div');
      const ts = new Date().toLocaleTimeString();
      line.innerText = `[${ts}] ${msg}`;
      if (type === 'error') line.className = 'log-err';
      if (type === 'warn') line.className = 'log-warn';
      debugLog.appendChild(line);
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(msg);
    }
    
    // Global Error Handler
    window.onerror = function(msg, source, lineno) {
      log(`JS Error: ${msg} (Line ${lineno})`, 'error');
      document.getElementById('btnRetry').style.display = 'block';
      document.getElementById('loadingText').innerText = "System Crashed";
      document.getElementById('loadingText').style.color = "#ef4444";
      document.getElementById('spinner').style.display = 'none';
    };

    // --- CONFIG ---
    // Using FULL model for accuracy. If this fails, we can switch to LITE.
    const MODEL_ASSET_PATH = "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/1/pose_landmarker_full.task";
    const WASM_PATH = "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/wasm";

    // --- STATE ---
    const state = {
      calibrated: false,
      recording: false,
      scale: 1.0, 
      calibrationBuffer: [],
      recordBuffer: [],
      videoDims: { w: 0, h: 0 }
    };

    // --- DOM ---
    const els = {
      loading: document.getElementById('loadingScreen'),
      status: document.getElementById('systemStatus'),
      btnCam: document.getElementById('btnCamera'),
      btnCal: document.getElementById('btnCalibrate'),
      btnRec: document.getElementById('btnRecord'),
      btnStop: document.getElementById('btnStop'),
      btnExp: document.getElementById('btnExport'),
      lblScale: document.getElementById('lblScale'),
      vid: document.getElementById('videoElement'),
      metrics: document.getElementById('metricsOverlay'),
      vals: {
        phase: document.getElementById('valPhase'),
        rk: document.getElementById('valRKnee'),
        lk: document.getElementById('valLKnee'),
        step: document.getElementById('valStep')
      }
    };

    // --- 3D VARS ---
    let scene, camera, renderer, controls;
    const joints = [];
    const bones = [];
    let poseLandmarker = null;
    let lastTime = -1;

    // --- INIT SEQUENCE ---
    async function initSystem() {
      try {
        log("Starting initialization...");
        
        log("1. Initializing Three.js (3D Engine)...");
        initThreeJS();
        
        log("2. Downloading MediaPipe WASM...");
        const vision = await FilesetResolver.forVisionTasks(WASM_PATH);
        
        log("3. Downloading Pose Model (Full)...");
        poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
          baseOptions: {
            modelAssetPath: MODEL_ASSET_PATH,
            delegate: "GPU"
          },
          runningMode: "VIDEO",
          numPoses: 1
        });
        
        log("Success! System Ready.");
        setTimeout(() => {
          els.loading.style.display = 'none';
          els.btnCam.disabled = false;
          setStatus("READY", "#10b981"); // Green
        }, 500);

      } catch (err) {
        log(`CRITICAL ERROR: ${err.message}`, 'error');
        alert(`Failed to load. See log.`);
      }
    }

    function initThreeJS() {
      const container = document.getElementById('canvasContainer');
      
      scene = new THREE.Scene();
      // Gradient background via CSS, scene transparent
      
      camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
      camera.position.set(0, 1.2, 3.5);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 1, 0);
      controls.enableDamping = true;

      // Lights
      const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
      dirLight.position.set(2, 4, 3);
      scene.add(dirLight);

      // Floor Grid
      const grid = new THREE.GridHelper(5, 10, 0x334155, 0x1e293b);
      scene.add(grid);

      // Init Skeleton (Spheres & Cylinders)
      // 33 Landmarks
      const jointGeo = new THREE.SphereGeometry(0.035, 16, 16);
      const jointMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.2, metalness: 0.5 });
      
      for(let i=0; i<33; i++) {
        const mesh = new THREE.Mesh(jointGeo, jointMat.clone());
        mesh.visible = false;
        scene.add(mesh);
        joints.push(mesh);
      }

      // Connections
      const connections = PoseLandmarker.POSE_CONNECTIONS;
      const boneGeo = new THREE.CylinderGeometry(0.015, 0.015, 1, 8);
      const boneMat = new THREE.MeshStandardMaterial({ color: 0x94a3b8, transparent: true, opacity: 0.8 });
      
      connections.forEach(conn => {
        const mesh = new THREE.Mesh(boneGeo, boneMat.clone());
        mesh.visible = false;
        scene.add(mesh);
        bones.push({ mesh, start: conn.start, end: conn.end });
      });

      // Render Loop
      const animate = () => {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      };
      animate();
      
      window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      });
    }

    // --- APP LOGIC ---

    els.btnCam.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: {ideal: 1280}, height: {ideal: 720} } });
        els.vid.srcObject = stream;
        els.vid.addEventListener('loadeddata', () => {
          state.videoDims = { w: els.vid.videoWidth, h: els.vid.videoHeight };
          els.btnCam.disabled = true;
          els.btnCal.disabled = false;
          setStatus("PREVIEW", "#38bdf8");
          renderLoop();
        });
      } catch (e) {
        log("Cam Error: " + e.message, 'error');
        alert("Camera error");
      }
    });

    els.btnCal.addEventListener('click', () => {
      state.calibrationBuffer = [];
      setStatus("CALIBRATING...", "#f59e0b");
      setTimeout(finishCalibration, 2000); // 2 sec capture
    });

    function finishCalibration() {
      if (state.calibrationBuffer.length < 5) {
        alert("Not enough data. Stand visible in front of camera.");
        setStatus("PREVIEW", "#38bdf8");
        return;
      }
      // Avg height from MP (normalized meters usually around 1.6-1.8 in world space but varies)
      // MP World coords: roughly meters relative to hips.
      // We calculate scale: Real Height / MP Height
      const mpHeights = state.calibrationBuffer.sort((a,b)=>a-b);
      const medianMP = mpHeights[Math.floor(mpHeights.length/2)];
      
      const realH = parseFloat(document.getElementById('inputHeight').value);
      state.scale = realH / medianMP;
      state.calibrated = true;
      
      els.lblScale.value = state.scale.toFixed(4);
      els.btnCal.disabled = true;
      els.btnRec.disabled = false;
      els.metrics.style.display = 'block';
      setStatus("CALIBRATED", "#10b981");
    }

    els.btnRec.addEventListener('click', () => {
      state.recordBuffer = [];
      state.recording = true;
      els.btnRec.disabled = true;
      els.btnStop.disabled = false;
      els.btnCal.disabled = true;
      setStatus("RECORDING", "#ef4444");
    });

    els.btnStop.addEventListener('click', () => {
      state.recording = false;
      els.btnStop.disabled = true;
      els.btnRec.disabled = false;
      els.btnExp.disabled = false;
      setStatus("DONE", "#38bdf8");
    });

    els.btnExp.addEventListener('click', () => {
      if (!state.recordBuffer.length) return;
      
      let csv = "Timestamp,Phase,RightKneeFlex_deg,LeftKneeFlex_deg,";
      for(let i=0; i<33; i++) csv += `J${i}_x,J${i}_y,J${i}_z,`;
      csv += "\n";
      
      state.recordBuffer.forEach(row => {
        csv += `${row.t.toFixed(3)},${row.ph},${row.rk.toFixed(1)},${row.lk.toFixed(1)},`;
        row.lm.forEach(p => csv += `${p.x.toFixed(4)},${p.y.toFixed(4)},${p.z.toFixed(4)},`);
        csv += "\n";
      });
      
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `biogait_3d_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
    });

    // --- RENDER & PROCESS LOOP ---
    async function renderLoop() {
      if (els.vid.currentTime !== lastTime) {
        lastTime = els.vid.currentTime;
        const res = poseLandmarker.detectForVideo(els.vid, performance.now());
        
        if (res.worldLandmarks && res.worldLandmarks.length > 0) {
          const lm = res.worldLandmarks[0]; // 3D Coordinates
          updateSkeleton(lm);
          processMetrics(lm, els.vid.currentTime);
        }
      }
      requestAnimationFrame(renderLoop);
    }

    function updateSkeleton(lm) {
      // Scale if calibrated, otherwise 1.0
      const s = state.calibrated ? state.scale : 1.0;

      // Update Joints
      for(let i=0; i<33; i++) {
        const mesh = joints[i];
        if(mesh) {
          // MP: -Y is up? No, usually Y is down in screen, but in World it's Y up or down depending on version.
          // Standard MP World: Y is down. We invert Y for ThreeJS (Y up).
          mesh.position.set(lm[i].x * s, -lm[i].y * s + (state.calibrated ? 1.0 : 0), -lm[i].z * s);
          mesh.visible = true;
          
          // Color
          let color = 0xffffff;
          if (i > 10 && i % 2 !== 0) color = 0x38bdf8; // Left (Blue)
          if (i > 10 && i % 2 === 0) color = 0xf97316; // Right (Orange)
          mesh.material.color.setHex(color);
        }
      }

      // Update Bones
      bones.forEach(b => {
        const p1 = joints[b.start].position;
        const p2 = joints[b.end].position;
        
        b.mesh.position.copy(p1).add(p2).multiplyScalar(0.5);
        b.mesh.lookAt(p2);
        b.mesh.rotateX(Math.PI/2);
        
        const dist = p1.distanceTo(p2);
        b.mesh.scale.set(1, dist, 1);
        b.mesh.visible = true;
      });
    }

    function processMetrics(lm, time) {
      // 23=L_Hip, 24=R_Hip, 25=L_Knee, 26=R_Knee, 27=L_Ankle, 28=R_Ankle
      
      // Calculate Height for Calibration (Nose to mid-ankle)
      if (!state.calibrated && els.status.innerText.includes("CALIBRATING")) {
        const noseY = lm[0].y;
        const ankleY = (lm[27].y + lm[28].y)/2;
        state.calibrationBuffer.push(Math.abs(ankleY - noseY));
        return;
      }

      // Knee Angles
      const rKnee = getAngle(lm[24], lm[26], lm[28]);
      const lKnee = getAngle(lm[23], lm[25], lm[27]);
      
      // Phase & Step
      const lZ = lm[27].z;
      const rZ = lm[28].z;
      const phase = (lZ < rZ) ? "L.Swing" : "R.Swing"; // Simplified
      const step = Math.abs(lZ - rZ) * (state.calibrated ? state.scale : 1);

      // UI
      els.vals.rk.innerText = rKnee.toFixed(0) + "째";
      els.vals.lk.innerText = lKnee.toFixed(0) + "째";
      els.vals.phase.innerText = phase;
      els.vals.step.innerText = state.calibrated ? step.toFixed(2) + "m" : "Uncal";

      // Record
      if (state.recording) {
        state.recordBuffer.push({
          t: time,
          ph: phase,
          rk: rKnee,
          lk: lKnee,
          lm: lm // Raw MP 3D coords
        });
      }
    }

    function getAngle(a, b, c) {
      // Vector BA, BC
      const v1 = {x: a.x-b.x, y: a.y-b.y, z: a.z-b.z};
      const v2 = {x: c.x-b.x, y: c.y-b.y, z: c.z-b.z};
      
      const dot = v1.x*v2.x + v1.y*v2.y + v1.z*v2.z;
      const mag1 = Math.sqrt(v1.x**2 + v1.y**2 + v1.z**2);
      const mag2 = Math.sqrt(v2.x**2 + v2.y**2 + v2.z**2);
      
      const rad = Math.acos(dot / (mag1*mag2));
      return 180 - (rad * (180/Math.PI));
    }

    function setStatus(msg, color) {
      els.status.innerText = msg;
      els.status.style.background = color;
      els.status.style.color = (color === '#38bdf8' || color === '#10b981') ? '#000' : '#fff';
    }

    // BOOT
    initSystem();

  </script>
</body>
</html>